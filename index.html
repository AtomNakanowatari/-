<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>英単語トレーニング</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1em;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    button {
      padding: 0.6em 1em;
      font-size: 1em;
      margin: 0.3em 0.3em 0.6em 0;
      border: 1px solid #999;
      border-radius: 4px;
    }
    .choice {
      cursor: pointer;
      margin: 0.2em 0;
      padding: 0.3em 0.6em;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 350px;
      box-sizing: border-box;
      transition: background 0.2s ease;
    }
    .choice:hover {
      background-color: #f0f0f0;
    }
    .hidden {
      display: none;
    }
    #scoreBox {
      margin-top: 2em;
      font-size: 0.9em;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>英単語トレーニング</h1>

  <div>
    <strong>通常：</strong>
    <button onclick="startMode('beginner')">初級</button>
    <button onclick="startMode('advanced')">上級</button>
  </div>

  <div>
    <strong>頭文字指定：</strong>
    <button onclick="startLetterMode('beginner')">初級</button>
    <button onclick="startLetterMode('advanced')">上級</button>
  </div>

  <div>
    <strong>復習モード：</strong>
    <button onclick="startReviewMode('beginner')">初級</button>
    <button onclick="startReviewMode('advanced')">上級</button>
  </div>

  <div>
    <strong>文脈補完モード：</strong>
    <button onclick="startContextChoiceMode()">4択式</button>
  </div>

  <h2 id="modeLabel"></h2>

  <div id="questionBox">
    <p><strong>問題：</strong> <span id="questionText" onclick="speakCurrent()">---</span></p>
    <div id="choices" class="hidden"></div>
  </div>

  <p id="resultText"></p>

  <div id="scoreBox">
    正解：<span id="correctCount">0</span>　
    不正解：<span id="wrongCount">0</span>　
    正答率：<span id="accuracy">0%</span>
  </div>
<script>
  let wordList = [];
  let currentList = [];
  let currentQuestion = null;
  let lastIndex = -1;
  let correctCount = 0;
  let wrongCount = 0;
  let reviewList = [];

  fetch("words.json")
    .then(res => res.json())
    .then(data => { wordList = data; });

  function resetUI() {
    document.getElementById("questionText").textContent = "---";
    document.getElementById("choices").innerHTML = "";
    document.getElementById("resultText").textContent = "";
    document.getElementById("choices").classList.add("hidden");
  }

  function getNewWord() {
    if (!currentList || currentList.length === 0) return null;
    let idx;
    do {
      idx = Math.floor(Math.random() * currentList.length);
    } while (idx === lastIndex && currentList.length > 1);
    lastIndex = idx;
    return currentList[idx];
  }

  function startContextChoiceMode() {
    currentList = wordList;
    resetUI();
    document.getElementById("modeLabel").textContent = "文脈補完モード（4択式）";
    startContextChoiceQuiz();
  }

  function startContextChoiceQuiz() {
    const word = getNewWord();
    if (!word) return;
    currentQuestion = word;

    const sentence = generateMaskedSentence(word);
    document.getElementById("questionText").textContent = sentence;

    const choices = shuffleChoices(word.word);
    const choiceBox = document.getElementById("choices");
    choiceBox.innerHTML = "";
    choices.forEach(c => {
      const div = document.createElement("div");
      div.className = "choice";
      div.textContent = c;
      div.onclick = () => checkChoice(c);
      choiceBox.appendChild(div);
    });
    choiceBox.classList.remove("hidden");
  }

  function generateMaskedSentence(wordObj) {
    const raw = wordObj.example;
    const target = wordObj.word;
    const lower = target.toLowerCase();

    const regex = new RegExp(`\\b${lower}\\b`, "gi");
    if (regex.test(raw)) {
      return raw.replace(regex, "_____");
    } else {
      return `「${wordObj.meaning}」に最もふさわしい語を選びなさい。`;
    }
  }
</script>
<script>
  function checkChoice(selected) {
    const correct = currentQuestion.word;
    const isCorrect = selected === correct;

    const result = isCorrect
      ? "✅ 正解！"
      : `❌ 不正解… 正解は「${correct}」`;

    document.getElementById("resultText").textContent = result;

    if (!isCorrect && !reviewList.some(w => w.word === correct)) {
      reviewList.push(currentQuestion);
    }

    updateScore(isCorrect);

    setTimeout(() => {
      document.getElementById("resultText").textContent = "";
      startContextChoiceQuiz();
    }, 1500);
  }

  function updateScore(isCorrect) {
    if (isCorrect) correctCount++;
    else wrongCount++;
    document.getElementById("correctCount").textContent = correctCount;
    document.getElementById("wrongCount").textContent = wrongCount;
    const total = correctCount + wrongCount;
    const rate = total === 0 ? 0 : Math.round((correctCount / total) * 100);
    document.getElementById("accuracy").textContent = `${rate}%`;
  }
</script>
<script>
  function shuffleChoices(correct) {
    const options = [correct];
    while (options.length < 4 && wordList.length > 1) {
      const w = wordList[Math.floor(Math.random() * wordList.length)];
      if (!options.includes(w.word)) options.push(w.word);
    }
    return options.sort(() => Math.random() - 0.5);
  }
</script>
</body>
</html>